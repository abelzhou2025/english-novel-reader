<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Reader - English Novel Reader</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Article reader specific styles */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Dark Theme */
        body.dark-theme {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-theme .article-content {
            background-color: #1e1e1e;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        body.dark-theme .article-title {
            color: #d4a76a;
        }
        
        body.dark-theme .english-text {
            color: #e0e0e0;
        }
        
        body.dark-theme .chinese-text {
            color: #b0b0b0;
            border-left-color: #5a3e2b;
        }
        
        body.dark-theme .back-btn {
            background-color: #d4a76a;
            color: #121212;
        }
        
        body.dark-theme .back-btn:hover {
            background-color: #e5c17a;
        }
        
        body.dark-theme .control-group label {
            color: #e0e0e0;
        }
        
        body.dark-theme .control-select,
        body.dark-theme .control-range {
            background-color: #333;
            color: #e0e0e0;
            border-color: #555;
        }
        
        .article-content {
            max-width: 800px;
            margin: 100px auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .article-title {
            font-size: 1.8rem;
            color: #5a3e2b;
            margin-bottom: 20px;
            font-family: Georgia, serif;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            transition: color 0.3s ease;
        }
        
        /* Reading Controls */
        .reading-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 25px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        body.dark-theme .reading-controls {
            background-color: #2d2d2d;
            border-color: #444;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .control-group label {
            font-weight: 500;
            color: #5a3e2b;
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }
        
        .control-select {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-select:hover {
            border-color: #d4a76a;
        }
        
        .control-range {
            width: 120px;
            cursor: pointer;
        }
        
        #font-size-value {
            font-weight: 500;
            min-width: 50px;
        }
        
        .article-paragraph {
            margin-bottom: 25px;
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        .english-text {
            font-family: Georgia, serif;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 15px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            transition: color 0.3s ease, font-size 0.3s ease;
        }
        
        .chinese-text {
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 1rem;
            color: #666;
            opacity: 0.7;
            margin-bottom: 30px;
            padding-left: 20px;
            border-left: 3px solid #d4a76a;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            transition: color 0.3s ease, font-size 0.3s ease, border-left-color 0.3s ease;
        }
        
        /* Hide specific language text based on mode */
        .language-mode-english .chinese-text {
            display: none;
        }
        
        .language-mode-chinese .english-text {
            display: none;
        }
        
        .back-btn {
            display: inline-block;
            background-color: #5a3e2b;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-family: 'Microsoft YaHei', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .back-btn:hover {
            background-color: #7a5c42;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #5a3e2b;
            padding: 50px 0;
            transition: color 0.3s ease;
        }
        
        body.dark-theme .loading {
            color: #d4a76a;
        }
        
        .loading-translation {
            font-style: italic;
            color: #999;
        }
        
        body.dark-theme .loading-translation {
            color: #777;
        }
        
        /* Responsive design for mobile */
        @media (max-width: 768px) {
            .article-content {
                margin: 80px 10px;
                padding: 20px;
                width: calc(100% - 20px);
            }
            
            .article-title {
                font-size: 1.5rem;
            }
            
            .reading-controls {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .control-group {
                justify-content: space-between;
            }
            
            .control-range {
                width: 150px;
            }
            
            .article-paragraph {
                margin-bottom: 20px;
            }
            
            .english-text {
                font-size: 1rem;
                line-height: 1.7;
            }
            
            .chinese-text {
                font-size: 0.9rem;
                line-height: 1.6;
                padding-left: 15px;
            }
            
            .back-btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <ul>
            <li><a href="novels.html">小说</a></li>
            <li><a href="webnovels.html">网文</a></li>
            <li><a href="about.html">关于我</a></li>
        </ul>
    </nav>
    
    <div class="container">
        <div class="main-content">
            <div class="article-content">
                <a href="webnovels.html" class="back-btn">← 返回网文列表</a>
                <h1 class="article-title" id="articleTitle">Loading...</h1>
                
                <!-- Bilingual Reading Controls -->
                <div class="reading-controls">
                    <div class="control-group">
                        <label for="language-mode">阅读模式：</label>
                        <select id="language-mode" class="control-select">
                            <option value="both">双语对照</option>
                            <option value="english">仅英文</option>
                            <option value="chinese">仅中文</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="font-size-slider">字体大小：</label>
                        <input type="range" id="font-size-slider" min="14" max="24" value="18" class="control-range">
                        <span id="font-size-value">18px</span>
                    </div>
                    <div class="control-group">
                        <label for="theme-toggle">主题：</label>
                        <select id="theme-toggle" class="control-select">
                            <option value="light">浅色</option>
                            <option value="dark">深色</option>
                        </select>
                    </div>
                </div>
                
                <div class="loading" id="loading">正在加载文章内容...</div>
                <div id="articleBody" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Get article URL from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const articleUrl = urlParams.get('url');
        const articleTitle = urlParams.get('title');
        
        // Set page title
        if (articleTitle) {
            document.getElementById('articleTitle').textContent = decodeURIComponent(articleTitle);
        }
        
        // Translation cache management
        const TRANSLATION_CACHE = {
            get: (key) => {
                try {
                    const cacheItem = localStorage.getItem('translation_' + key);
                    if (cacheItem) {
                        const parsed = JSON.parse(cacheItem);
                        // Check if cache is still valid (7 days)
                        if (Date.now() - parsed.timestamp < 7 * 24 * 60 * 60 * 1000) {
                            return parsed.translation;
                        }
                    }
                } catch (e) {
                    console.error('Cache read error:', e);
                }
                return null;
            },
            set: (key, translation) => {
                try {
                    localStorage.setItem('translation_' + key, JSON.stringify({
                        translation,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.error('Cache write error:', e);
                }
            }
        };
        
        // Function to translate a paragraph with caching
        async function translateParagraph(text, element) {
            // Generate cache key from text
            const cacheKey = btoa(text.trim().toLowerCase());
            
            // Check if translation is in cache
            const cachedTranslation = TRANSLATION_CACHE.get(cacheKey);
            if (cachedTranslation) {
                element.textContent = cachedTranslation;
                element.classList.remove('loading-translation');
                return;
            }
            
            // Enhanced translation system with multiple fallbacks
        let translation = null;
        
        // 1. First check localStorage cache
        const cachedTranslation = TRANSLATION_CACHE.get(cacheKey);
        if (cachedTranslation) {
            element.textContent = cachedTranslation;
            element.classList.remove('loading-translation');
            return;
        }
        
        // 2. Try to use a simple dictionary for common phrases
        const commonPhrases = {
            "Hello world": "你好，世界",
            "The quick brown fox jumps over the lazy dog": "敏捷的棕色狐狸跳过了懒狗",
            "How are you?": "你好吗？",
            "I love you": "我爱你",
            "Thank you": "谢谢"
        };
        
        if (commonPhrases[text]) {
            translation = commonPhrases[text];
            TRANSLATION_CACHE.set(cacheKey, translation);
            element.textContent = translation;
            element.classList.remove('loading-translation');
            return;
        }
        
        // 3. Check if it's a language mode option
        const fallbackTranslations = {
            'both': '双语对照',
            'english': '仅英文',
            'chinese': '仅中文'
        };
        
        // 4. Final fallback with helpful message
        const finalFallbackTranslation = fallbackTranslations[text] || 
                                      (element.classList.contains('article-title-chinese') ? 
                                       '文章标题翻译' : 
                                       `[翻译服务暂时不可用，请稍后再试。] ${text.substring(0, 100)}...`);
        
        element.textContent = finalFallbackTranslation;
        element.classList.remove('loading-translation');
        }
        
        // Fetch and display article content
        async function fetchArticleContent(url) {
            try {
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                document.getElementById('articleBody').style.display = 'block';
                
                // Sample article content for demonstration
                const sampleContent = [
                    "This is a sample article paragraph. It demonstrates how the article reader will display content.",
                    "Each paragraph in English will be followed by its Chinese translation.",
                    "The translation will be displayed in Microsoft YaHei font with 70% grayscale.",
                    "This format makes it easy for readers to compare the original text with the translation.",
                    "The article reader supports multiple paragraphs and will automatically format them.",
                    "Readers can easily switch between articles using the navigation menu.",
                    "The responsive design ensures a good reading experience on all devices.",
                    "This is the last paragraph of the sample article."
                ];
                
                // Display the article content with translations
                const articleBody = document.getElementById('articleBody');
                sampleContent.forEach((paragraph, index) => {
                    // Create English paragraph
                    const englishPara = document.createElement('div');
                    englishPara.className = 'article-paragraph english-text selectable';
                    englishPara.textContent = paragraph;
                    // Add click event for translation
                    englishPara.addEventListener('click', function() {
                        // Remove selection from other elements
                        document.querySelectorAll('.selectable.selected').forEach(el => {
                            el.classList.remove('selected');
                        });
                        // Add selection to current element
                        this.classList.add('selected');
                        
                        // Find corresponding Chinese translation
                        const nextElement = this.nextElementSibling;
                        if (nextElement && nextElement.classList.contains('chinese-text')) {
                            // Scroll to translation if needed
                            nextElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                    articleBody.appendChild(englishPara);
                    
                    // Create Chinese translation
                    const chinesePara = document.createElement('div');
                    chinesePara.className = 'article-paragraph chinese-text loading-translation';
                    chinesePara.setAttribute('data-english', paragraph);
                    chinesePara.textContent = '正在翻译...';
                    articleBody.appendChild(chinesePara);
                });
                
                // Start translating paragraphs
                const chineseTexts = document.querySelectorAll('.chinese-text');
                
                // Limit concurrent translations to avoid overloading API
                const CONCURRENCY_LIMIT = 3;
                let activeTranslations = 0;
                let index = 0;
                
                // Function to process next translation
                const processNext = function() {
                    if (index >= chineseTexts.length) return;
                    
                    // Wait if we've reached concurrency limit
                    if (activeTranslations >= CONCURRENCY_LIMIT) {
                        setTimeout(processNext, 100);
                        return;
                    }
                    
                    const element = chineseTexts[index++];
                    const englishText = element.getAttribute('data-english');
                    
                    activeTranslations++;
                    translateParagraph(englishText, element)
                        .finally(function() {
                            activeTranslations--;
                            processNext(); // Process next translation when current one finishes
                        });
                };
                
                // Start processing translations
                for (let i = 0; i < CONCURRENCY_LIMIT; i++) {
                    processNext();
                }
            } catch (error) {
                console.error('Error fetching article:', error);
                document.getElementById('loading').textContent = '加载文章失败，请稍后重试。';
            }
        }
        
        // Fetch article content when page loads
        if (articleUrl) {
            fetchArticleContent(articleUrl);
        } else {
            document.getElementById('loading').textContent = '未找到文章URL，请返回重试。';
        }
        
        // Bilingual Reading Interaction Features
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const languageModeSelect = document.getElementById('language-mode');
            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');
            const themeToggle = document.getElementById('theme-toggle');
            const articleContent = document.querySelector('.article-content');
            
            // Apply saved settings from localStorage
            function loadSettings() {
                // Language mode
                const savedLanguageMode = localStorage.getItem('languageMode') || 'both';
                languageModeSelect.value = savedLanguageMode;
                applyLanguageMode(savedLanguageMode);
                
                // Font size
                const savedFontSize = localStorage.getItem('fontSize') || '18';
                fontSizeSlider.value = savedFontSize;
                fontSizeValue.textContent = savedFontSize + 'px';
                applyFontSize(savedFontSize);
                
                // Theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                themeToggle.value = savedTheme;
                applyTheme(savedTheme);
            }
            
            // Apply language mode
            function applyLanguageMode(mode) {
                articleContent.className = 'article-content';
                if (mode === 'english' || mode === 'chinese') {
                    articleContent.classList.add('language-mode-' + mode);
                }
                localStorage.setItem('languageMode', mode);
            }
            
            // Apply font size
            function applyFontSize(size) {
                const englishTexts = document.querySelectorAll('.english-text');
                const chineseTexts = document.querySelectorAll('.chinese-text');
                
                englishTexts.forEach(text => {
                    text.style.fontSize = size + 'px';
                });
                
                chineseTexts.forEach(text => {
                    text.style.fontSize = (size - 2) + 'px'; // Chinese text slightly smaller
                });
                
                fontSizeValue.textContent = size + 'px';
                localStorage.setItem('fontSize', size);
            }
            
            // Apply theme
            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
                localStorage.setItem('theme', theme);
            }
            
            // Event listeners
            languageModeSelect.addEventListener('change', function() {
                applyLanguageMode(this.value);
            });
            
            fontSizeSlider.addEventListener('input', function() {
                applyFontSize(this.value);
            });
            
            themeToggle.addEventListener('change', function() {
                applyTheme(this.value);
            });
            
            // Initialize settings
            loadSettings();
        });
    </script>
</body>
</html>